"""
Strategy Explanations System
Gera e exibe documenta√ß√£o para todas as 13 estrat√©gias
"""

import os
from pathlib import Path
from typing import Dict


class StrategyExplanations:
    """Gerencia explica√ß√µes de estrat√©gias"""
    
    def __init__(self):
        self.explanations_dir = Path(__file__).parent
        self.strategies = self._define_strategies()
    
    def _define_strategies(self) -> Dict[str, Dict]:
        """Define metadados e explica√ß√µes das 13 estrat√©gias"""
        return {
            "rsi_mean_reversion": {
                "name": "RSI Mean Reversion",
                "emoji": "üìä",
                "type": "Oscillator",
                "description": "Estrat√©gia de revers√£o √† m√©dia baseada no RSI (Relative Strength Index)",
                "logic": """
Identifica momentos de sobrecompra e sobrevenda atrav√©s do RSI:
- RSI < 30: Mercado sobrevendido ‚Üí sinal BUY (revers√£o esperada para cima)
- RSI > 70: Mercado sobrecomprado ‚Üí sinal SELL (revers√£o esperada para baixo)
- RSI entre 30-70: Neutro ‚Üí HOLD
                """,
                "triggers": {
                    "BUY": "RSI cai abaixo de 30 (sobrevenda)",
                    "SELL": "RSI sobe acima de 70 (sobrecompra)",
                    "Confidence": "Quanto mais distante do threshold, maior a confian√ßa"
                },
                "parameters": {
                    "rsi_period": "14 candles (per√≠odo de c√°lculo do RSI)",
                    "oversold": "30 (n√≠vel de sobrevenda)",
                    "overbought": "70 (n√≠vel de sobrecompra)"
                },
                "best_for": "Mercados laterais, ativos com alta volatilidade, timeframes curtos (1m-15m)",
                "avoid": "Tend√™ncias fortes (breakouts), baixa liquidez"
            },
            
            "ema_crossover": {
                "name": "EMA Crossover",
                "emoji": "üìà",
                "type": "Trend Following",
                "description": "Cruzamento de m√©dias m√≥veis exponenciais para identificar tend√™ncias",
                "logic": """
Utiliza duas EMAs (r√°pida e lenta) para detectar mudan√ßas de tend√™ncia:
- EMA r√°pida cruza acima da EMA lenta ‚Üí sinal BUY (in√≠cio de tend√™ncia de alta)
- EMA r√°pida cruza abaixo da EMA lenta ‚Üí sinal SELL (in√≠cio de tend√™ncia de baixa)
                """,
                "triggers": {
                    "BUY": "EMA12 cruza acima de EMA26 (Golden Cross)",
                    "SELL": "EMA12 cruza abaixo de EMA26 (Death Cross)",
                    "Confidence": "Baseada na dist√¢ncia entre as EMAs"
                },
                "parameters": {
                    "fast_ema": "12 per√≠odos (EMA r√°pida)",
                    "slow_ema": "26 per√≠odos (EMA lenta)"
                },
                "best_for": "Tend√™ncias claras, timeframes m√©dios (15m-1h), alta liquidez",
                "avoid": "Mercados laterais (gera muitos falsos sinais)"
            },
            
            "bollinger_breakout": {
                "name": "Bollinger Bands Breakout",
                "emoji": "üéØ",
                "type": "Volatility",
                "description": "Rompimento das Bandas de Bollinger para capturar expans√µes de volatilidade",
                "logic": """
Detecta breakouts quando pre√ßo rompe as bandas:
- Pre√ßo fecha ACIMA da banda superior ‚Üí sinal BUY (momentum forte)
- Pre√ßo fecha ABAIXO da banda inferior ‚Üí sinal SELL (press√£o vendedora)
                """,
                "triggers": {
                    "BUY": "Close > Banda Superior (breakout bullish)",
                    "SELL": "Close < Banda Inferior (breakout bearish)",
                    "Confidence": "Dist√¢ncia do pre√ßo em rela√ß√£o √† banda"
                },
                "parameters": {
                    "period": "20 candles (per√≠odo da MA central)",
                    "std_dev": "2.0 (desvios padr√£o das bandas)"
                },
                "best_for": "Breakouts de consolida√ß√£o, alta volatilidade, not√≠cias importantes",
                "avoid": "Mercados de range estreito, baixa volatilidade"
            },
            
            "macd": {
                "name": "MACD",
                "emoji": "üìä",
                "type": "Momentum",
                "description": "Moving Average Convergence Divergence - identificador de momentum e revers√µes",
                "logic": """
Compara EMAs e sinaliza mudan√ßas de momentum:
- MACD cruza acima da linha de sinal ‚Üí BUY (momentum bullish)
- MACD cruza abaixo da linha de sinal ‚Üí SELL (momentum bearish)
- Histograma positivo/negativo confirma dire√ß√£o
                """,
                "triggers": {
                    "BUY": "MACD line cruza acima da Signal line",
                    "SELL": "MACD line cruza abaixo da Signal line",
                    "Confidence": "Magnitude do histograma"
                },
                "parameters": {
                    "fast_period": "12 (EMA r√°pida)",
                    "slow_period": "26 (EMA lenta)",
                    "signal_period": "9 (linha de sinal)"
                },
                "best_for": "Identificar revers√µes, confirmar tend√™ncias, timeframes m√©dios",
                "avoid": "Choppy markets (oscila√ß√µes r√°pidas)"
            },
            
            "stochastic": {
                "name": "Stochastic Oscillator",
                "emoji": "üìà",
                "type": "Oscillator",
                "description": "Oscilador que compara pre√ßo atual com range recente",
                "logic": """
Mede posi√ß√£o do pre√ßo em rela√ß√£o ao range:
- %K cruza acima de %D em zona oversold ‚Üí BUY
- %K cruza abaixo de %D em zona overbought ‚Üí SELL
                """,
                "triggers": {
                    "BUY": "%K > %D e ambos < 20 (oversold)",
                    "SELL": "%K < %D e ambos > 80 (overbought)",
                    "Confidence": "Posi√ß√£o em rela√ß√£o aos thresholds"
                },
                "parameters": {
                    "k_period": "14 (per√≠odo %K)",
                    "d_period": "3 (suaviza√ß√£o %D)",
                    "oversold": "20",
                    "overbought": "80"
                },
                "best_for": "Scalping, revers√µes de curto prazo, timeframes baixos",
                "avoid": "Tend√™ncias fortes prolongadas"
            },
            
            "williams_r": {
                "name": "Williams %R",
                "emoji": "üìâ",
                "type": "Oscillator",
                "description": "Oscilador de momentum medindo dist√¢ncia do pre√ßo em rela√ß√£o ao high/low",
                "logic": """
Identifica condi√ß√µes extremas de mercado:
- %R < -80: Oversold ‚Üí BUY esperado
- %R > -20: Overbought ‚Üí SELL esperado
                """,
                "triggers": {
                    "BUY": "%R cruza acima de -80 (saindo de oversold)",
                    "SELL": "%R cruza abaixo de -20 (saindo de overbought)",
                    "Confidence": "Velocidade da mudan√ßa"
                },
                "parameters": {
                    "period": "14 (lookback)",
                    "oversold": "-80",
                    "overbought": "-20"
                },
                "best_for": "Identificar revers√µes, complementar outras estrat√©gias",
                "avoid": "Usar isoladamente em tend√™ncias"
            },
            
            "adx": {
                "name": "ADX (Average Directional Index)",
                "emoji": "üéØ",
                "type": "Trend Strength",
                "description": "Mede for√ßa da tend√™ncia independente de dire√ß√£o",
                "logic": """
Determina se vale a pena seguir a tend√™ncia:
- ADX > 25 + DI+ > DI- ‚Üí BUY (tend√™ncia bullish forte)
- ADX > 25 + DI- > DI+ ‚Üí SELL (tend√™ncia bearish forte)
- ADX < 25 ‚Üí Sem tend√™ncia clara
                """,
                "triggers": {
                    "BUY": "ADX > 25 e +DI cruza acima de -DI",
                    "SELL": "ADX > 25 e -DI cruza acima de +DI",
                    "Confidence": "Valor do ADX (quanto maior, mais forte)"
                },
                "parameters": {
                    "period": "14 (c√°lculo de ADX)",
                    "adx_threshold": "25 (m√≠nimo para tend√™ncia forte)"
                },
                "best_for": "Confirmar tend√™ncias, evitar false breakouts",
                "avoid": "Mercados laterais (ADX baixo)"
            },
            
            "fibonacci": {
                "name": "Fibonacci Retracement",
                "emoji": "üî¢",
                "type": "Support/Resistance",
                "description": "N√≠veis de retra√ß√£o de Fibonacci para identificar suportes/resist√™ncias",
                "logic": """
Calcula n√≠veis de Fibonacci no swing mais recente:
- Pre√ßo toca 0.618 ou 0.786 e reverte ‚Üí BUY (em downtrend)
- Pre√ßo toca 0.382 ou 0.236 e reverte ‚Üí SELL (em uptrend)
                """,
                "triggers": {
                    "BUY": "Pre√ßo pr√≥ximo de n√≠vel Fib (0.618/0.786) em pullback",
                    "SELL": "Pre√ßo pr√≥ximo de n√≠vel Fib (0.382/0.236) em rally",
                    "Confidence": "Proximidade exata do n√≠vel"
                },
                "parameters": {
                    "lookback_period": "50 (para detectar swing)",
                    "tolerance_pct": "0.5% (margem de erro)"
                },
                "best_for": "Tend√™ncias com pullbacks, n√≠veis de entrada precisos",
                "avoid": "Mercados sem tend√™ncia definida"
            },
            
            "smc_bos": {
                "name": "SMC: Break of Structure",
                "emoji": "üî•",
                "type": "Smart Money Concepts",
                "description": "Continua√ß√£o de tend√™ncia ap√≥s rompimento de swing high/low",
                "logic": """
Identifica quando 'smart money' est√° empurrando o mercado:
- Pre√ßo rompe swing high anterior ‚Üí BOS bullish ‚Üí BUY
- Pre√ßo rompe swing low anterior ‚Üí BOS bearish ‚Üí SELL
                """,
                "triggers": {
                    "BUY": "High atual > √∫ltimo swing high significativo",
                    "SELL": "Low atual < √∫ltimo swing low significativo",
                    "Confidence": "Magnitude do displacement"
                },
                "parameters": {
                    "min_displacement": "0.1% (movimento m√≠nimo para validar)"
                },
                "best_for": "Tend√™ncias fortes, continua√ß√£o de momentum, timeframes altos",
                "avoid": "Consolida√ß√µes, baixa liquidez"
            },
            
            "smc_choch": {
                "name": "SMC: Change of Character",
                "emoji": "üîÑ",
                "type": "Smart Money Concepts",
                "description": "Revers√£o quando sequ√™ncia de topos/fundos muda",
                "logic": """
Detecta mudan√ßa de estrutura de mercado:
- Uptrend: Low rompe low anterior ‚Üí CHoCH ‚Üí SELL
- Downtrend: High rompe high anterior ‚Üí CHoCH ‚Üí BUY
                """,
                "triggers": {
                    "BUY": "Em downtrend, high rompe high anterior (revers√£o)",
                    "SELL": "Em uptrend, low rompe low anterior (revers√£o)",
                    "Confidence": "For√ßa da quebra estrutural"
                },
                "parameters": {},
                "best_for": "Identificar revers√µes early, tops/bottoms de tend√™ncia",
                "avoid": "Mercados laterais com muitos whipsaws"
            },
            
            "smc_order_blocks": {
                "name": "SMC: Order Blocks",
                "emoji": "üì¶",
                "type": "Smart Money Concepts",
                "description": "√öltima vela de acumula√ß√£o antes do rompimento",
                "logic": """
Identifica zonas onde institui√ß√µes acumularam posi√ß√µes:
- Vela antes de BOS bullish = Bullish OB ‚Üí suporte futuro
- Vela antes de BOS bearish = Bearish OB ‚Üí resist√™ncia futura
                """,
                "triggers": {
                    "BUY": "Pre√ßo retorna para Bullish Order Block",
                    "SELL": "Pre√ßo retorna para Bearish Order Block",
                    "Confidence": "For√ßa do BOS subsequente"
                },
                "parameters": {
                    "min_range": "0 (tamanho m√≠nimo do bloco)"
                },
                "best_for": "Re-entries em tend√™ncia, zonas de interesse institucional",
                "avoid": "Mercados sem estrutura clara"
            },
            
            "smc_fvg": {
                "name": "SMC: Fair Value Gap",
                "emoji": "‚ö°",
                "type": "Smart Money Concepts",
                "description": "Gap entre corpos/sombras indicando imbalance",
                "logic": """
Detecta desequil√≠brio de oferta/demanda (gaps):
- Gap bullish (low[1] > high[-1]) ‚Üí pre√ßo deve preencher ‚Üí BUY
- Gap bearish (high[1] < low[-1]) ‚Üí pre√ßo deve preencher ‚Üí SELL
                """,
                "triggers": {
                    "BUY": "FVG bullish detectado (gap para cima)",
                    "SELL": "FVG bearish detectado (gap para baixo)",
                    "Confidence": "Tamanho do gap"
                },
                "parameters": {},
                "best_for": "Movimentos r√°pidos, imbalances institucionais",
                "avoid": "Mercados de baixa volatilidade"
            },
            
            "smc_liquidity_sweep": {
                "name": "SMC: Liquidity Sweep",
                "emoji": "üé£",
                "type": "Smart Money Concepts",
                "description": "Rompimento falso para capturar liquidez (stop hunt)",
                "logic": """
Identifica quando smart money ca√ßa stops:
- Spike acima de high anterior + revers√£o r√°pida ‚Üí Liquidity Grab ‚Üí SELL
- Spike abaixo de low anterior + revers√£o r√°pida ‚Üí Liquidity Grab ‚Üí BUY
                """,
                "triggers": {
                    "BUY": "Wick longo abaixo + revers√£o (sweep de lows)",
                    "SELL": "Wick longo acima + revers√£o (sweep de highs)",
                    "Confidence": "Tamanho do wick vs corpo"
                },
                "parameters": {},
                "best_for": "Identificar armadilhas, revers√µes ap√≥s stop hunt",
                "avoid": "Sem confirma√ß√£o de revers√£o"
            }
        }
    
    def generate_markdown_files(self):
        """Gera arquivos markdown para todas as estrat√©gias"""
        for key, data in self.strategies.items():
            filename = self.explanations_dir / f"{key}.md"
            content = self._create_markdown_content(key, data)
            
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(content)
            
            print(f"‚úÖ Gerado: {filename.name}")
    
    def _create_markdown_content(self, key: str, data: Dict) -> str:
        """Cria conte√∫do markdown formatado"""
        content = f"""# {data['emoji']} {data['name']}

**Tipo:** {data['type']}

## Descri√ß√£o
{data['description']}

## L√≥gica da Estrat√©gia
{data['logic']}

## Triggers de Sinal

"""
        
        for trigger_type, trigger_desc in data['triggers'].items():
            content += f"- **{trigger_type}**: {trigger_desc}\n"
        
        content += "\n## Par√¢metros\n\n"
        
        for param, desc in data['parameters'].items():
            content += f"- **{param}**: {desc}\n"
        
        content += f"""
## Melhor Para
{data['best_for']}

## Evitar
{data['avoid']}

## Exemplo de Uso

### Cen√°rio Bullish
Quando a estrat√©gia gera sinal BUY, indica que as condi√ß√µes favor√°veis para entrada long foram detectadas.

### Cen√°rio Bearish
Quando a estrat√©gia gera sinal SELL, indica que as condi√ß√µes favor√°veis para entrada short foram detectadas.

---
*Documento gerado automaticamente pelo Market Manus Strategy Lab*
"""
        
        return content
    
    def display_strategy(self, strategy_key: str):
        """Exibe explica√ß√£o de uma estrat√©gia"""
        if strategy_key not in self.strategies:
            print(f"‚ùå Estrat√©gia '{strategy_key}' n√£o encontrada")
            return
        
        data = self.strategies[strategy_key]
        
        print("\n" + "=" * 70)
        print(f"{data['emoji']} {data['name']}")
        print("=" * 70)
        print(f"\nTipo: {data['type']}")
        print(f"\n{data['description']}")
        print(f"\n{data['logic']}")
        print("\nTriggers:")
        for trigger, desc in data['triggers'].items():
            print(f"  ‚Ä¢ {trigger}: {desc}")
        print("\nPar√¢metros:")
        for param, desc in data['parameters'].items():
            print(f"  ‚Ä¢ {param}: {desc}")
        print(f"\n‚úÖ Melhor para: {data['best_for']}")
        print(f"‚ùå Evitar: {data['avoid']}")
        print("=" * 70)
    
    def list_all_strategies(self):
        """Lista todas as estrat√©gias dispon√≠veis"""
        print("\n" + "=" * 70)
        print("üìö ESTRAT√âGIAS DISPON√çVEIS (13 total)")
        print("=" * 70)
        
        # Agrupar por tipo
        classic = []
        smc = []
        
        for key, data in self.strategies.items():
            if key.startswith("smc_"):
                smc.append((key, data))
            else:
                classic.append((key, data))
        
        print("\nüìä CL√ÅSSICAS (8):")
        for key, data in classic:
            print(f"   {data['emoji']} {key.ljust(25)} - {data['name']}")
        
        print("\nüî• SMART MONEY CONCEPTS (5):")
        for key, data in smc:
            print(f"   {data['emoji']} {key.ljust(25)} - {data['name']}")
        
        print("=" * 70)


def run_explanations_menu():
    """Menu interativo de explanations"""
    explainer = StrategyExplanations()
    
    while True:
        print("\n" + "=" * 70)
        print("üìö MENU DE EXPLICA√á√ïES DAS ESTRAT√âGIAS")
        print("=" * 70)
        print("\n1Ô∏è‚É£  Listar todas as estrat√©gias")
        print("2Ô∏è‚É£  Ver explica√ß√£o detalhada de uma estrat√©gia")
        print("3Ô∏è‚É£  Gerar/Atualizar arquivos markdown")
        print("0Ô∏è‚É£  Voltar")
        
        choice = input("\nüî¢ Escolha uma op√ß√£o (0-3): ").strip()
        
        if choice == "1":
            explainer.list_all_strategies()
            input("\nüìñ Pressione ENTER para continuar...")
        
        elif choice == "2":
            explainer.list_all_strategies()
            strategy_key = input("\nüí° Digite o nome da estrat√©gia (ex: rsi_mean_reversion): ").strip()
            explainer.display_strategy(strategy_key)
            input("\nüìñ Pressione ENTER para continuar...")
        
        elif choice == "3":
            print("\nüìù Gerando arquivos markdown...")
            explainer.generate_markdown_files()
            print(f"\n‚úÖ Arquivos salvos em: {explainer.explanations_dir}")
            input("\nüìñ Pressione ENTER para continuar...")
        
        elif choice == "0":
            break
        
        else:
            print("‚ùå Op√ß√£o inv√°lida")


if __name__ == "__main__":
    run_explanations_menu()
