{% extends "base.html" %}

{% block title %}Backtest - Market Manus{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4"><i class="bi bi-bar-chart-line"></i> Backtest</h1>
        <p class="lead">Teste suas estrat√©gias com dados hist√≥ricos</p>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Configura√ß√µes</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">üåê Exchange</label>
                    <select class="form-select" id="backtest-exchange">
                        <option value="binance" selected>Binance</option>
                        <option value="bybit">Bybit</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üí± Ativo</label>
                    <select class="form-select" id="backtest-asset">
                        <option value="BTCUSDT" selected>BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="ADAUSDT">ADA/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">‚è∞ Timeframe</label>
                    <select class="form-select" id="backtest-timeframe">
                        <option value="1m">1 Minuto</option>
                        <option value="5m">5 Minutos</option>
                        <option value="15m" selected>15 Minutos</option>
                        <option value="1h">1 Hora</option>
                        <option value="4h">4 Horas</option>
                        <option value="1d">1 Dia</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üìÖ Data Inicial</label>
                    <input type="date" class="form-control" id="backtest-start-date">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üìÖ Data Final</label>
                    <input type="date" class="form-control" id="backtest-end-date">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üí∞ Capital Inicial</label>
                    <input type="number" class="form-control" id="backtest-capital" value="10000" step="100">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üéØ Modo de Conflu√™ncia</label>
                    <select class="form-select" id="backtest-mode">
                        <option value="WEIGHTED" selected>Weighted</option>
                        <option value="MAJORITY">Majority</option>
                        <option value="ALL">All</option>
                        <option value="ANY">Any</option>
                    </select>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enable-manus-ai">
                    <label class="form-check-label" for="enable-manus-ai">
                        ü§ñ Manus AI Premium
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enable-sk">
                    <label class="form-check-label" for="enable-sk">
                        üß† Semantic Kernel Advisor
                    </label>
                </div>
                
                <div class="d-grid mb-2">
                    <button class="btn btn-primary btn-lg" onclick="executeBacktest()">
                        <i class="bi bi-play-fill"></i> Executar Backtest
                    </button>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-secondary" onclick="manageCacheModal()">
                        <i class="bi bi-hdd"></i> Gerenciar Cache Hist√≥rico
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Cache Management Modal -->
        <div class="modal fade" id="cacheModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-hdd"></i> Cache de Dados Hist√≥ricos</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="cache-list" class="mb-3">
                            <p class="text-muted">Carregando cache...</p>
                        </div>
                        <button class="btn btn-danger" onclick="clearAllCache()">
                            <i class="bi bi-trash"></i> Limpar Todo Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Resultados</h5>
            </div>
            <div class="card-body">
                <div id="backtest-results" class="text-center text-muted py-5">
                    <i class="bi bi-bar-chart" style="font-size: 4rem;"></i>
                    <p class="mt-3">Configure o backtest e clique em "Executar Backtest"</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3" id="recommendations-card" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Recomenda√ß√µes IA</h5>
            </div>
            <div class="card-body" id="ai-recommendations">
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Definir data padr√£o (√∫ltimos 30 dias)
const today = new Date();
const thirtyDaysAgo = new Date(today);
thirtyDaysAgo.setDate(today.getDate() - 30);

document.getElementById('backtest-start-date').valueAsDate = thirtyDaysAgo;
document.getElementById('backtest-end-date').valueAsDate = today;

// Carregar estrat√©gias da URL se houver
const urlParams = new URLSearchParams(window.location.search);
let strategiesParam = urlParams.get('strategies');
const combinationParam = urlParams.get('combination');

// Se veio do Confluence Lab com combina√ß√£o, buscar estrat√©gias
if (combinationParam && !strategiesParam) {
    (async () => {
        try {
            const response = await fetch(`/api/combination/${combinationParam}`);
            const combo = await response.json();
            
            if (combo && combo.strategies) {
                strategiesParam = combo.strategies.join(',');
                console.log('Estrat√©gias carregadas da combina√ß√£o #' + combinationParam + ':', strategiesParam);
                
                // Atualizar modo de conflu√™ncia se especificado
                if (combo.mode) {
                    document.getElementById('backtest-mode').value = combo.mode;
                }
                
                // Mostrar mensagem informativa
                const resultsDiv = document.getElementById('backtest-results');
                resultsDiv.innerHTML = `
                    <div class="alert alert-success bg-dark border-success text-white">
                        <h6><i class="bi bi-check-circle"></i> Combina√ß√£o #${combinationParam} carregada!</h6>
                        <p><strong>${combo.name}</strong></p>
                        <p class="mb-0">${combo.strategies.length} estrat√©gias: ${combo.strategies.join(', ')}</p>
                        <p class="mb-0 mt-2"><small>Modo: ${combo.mode} | Win Rate esperado: ${combo.target_win_rate}</small></p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar combina√ß√£o:', error);
        }
    })();
}

if (strategiesParam) {
    console.log('Estrat√©gias selecionadas:', strategiesParam);
}

if (combinationParam) {
    console.log('Combina√ß√£o selecionada:', combinationParam);
}

async function executeBacktest() {
    const resultsDiv = document.getElementById('backtest-results');
    resultsDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Executando backtest...</span>
            </div>
            <p class="mt-3 text-white">üîÑ Executando backtest com dados reais da Binance...</p>
            <small class="text-muted">Isso pode levar alguns segundos</small>
        </div>
    `;
    
    const config = {
        exchange: document.getElementById('backtest-exchange').value,
        asset: document.getElementById('backtest-asset').value,
        timeframe: document.getElementById('backtest-timeframe').value,
        start_date: document.getElementById('backtest-start-date').value,
        end_date: document.getElementById('backtest-end-date').value,
        capital: parseFloat(document.getElementById('backtest-capital').value),
        mode: document.getElementById('backtest-mode').value,
        manus_ai: document.getElementById('enable-manus-ai').checked,
        semantic_kernel: document.getElementById('enable-sk').checked,
        strategies: strategiesParam ? strategiesParam.split(',') : []
    };
    
    // Validar sele√ß√£o de estrat√©gias
    if (!config.strategies || config.strategies.length === 0) {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning bg-dark border-warning text-white">
                <i class="bi bi-exclamation-triangle"></i> Por favor, selecione pelo menos uma estrat√©gia antes de executar o backtest.
            </div>
        `;
        return;
    }
    
    console.log('Executando backtest com configura√ß√£o:', config);
    
    const result = await runBacktest(config);
    
    if (result && result.status === 'success') {
        displayResults(result);
        showToast('Sucesso', `Backtest conclu√≠do! Win Rate: ${result.results.win_rate.toFixed(1)}%`, 'success');
    } else {
        displayResults(result || {status: 'error', message: 'Erro desconhecido ao executar backtest'});
        showToast('Erro', result?.message || 'N√£o foi poss√≠vel executar o backtest', 'danger');
    }
}

function displayResults(result) {
    const resultsDiv = document.getElementById('backtest-results');
    
    if (result.status === 'error') {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> Erro ao executar backtest</h6>
                <p>${result.message}</p>
            </div>
        `;
        return;
    }
    
    // Usar dados REAIS do backend
    const r = result.results;
    const pnl = r.final_capital - r.initial_capital;
    const pnlClass = pnl >= 0 ? 'text-success' : 'text-danger';
    const roiClass = r.roi >= 0 ? 'success' : 'danger';
    
    resultsDiv.innerHTML = `
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card bg-dark border-primary text-white">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Capital Final</h6>
                        <h3 class="text-primary">$${r.final_capital.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-${roiClass} text-white">
                    <div class="card-body text-center">
                        <h6 class="text-muted">ROI</h6>
                        <h3 class="${pnlClass}">${r.roi >= 0 ? '+' : ''}${r.roi.toFixed(2)}%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-info text-white">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Win Rate</h6>
                        <h3 class="text-info">${r.win_rate.toFixed(1)}%</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-3 mt-3">
            <div class="col-md-6">
                <div class="card bg-dark text-white border-secondary">
                    <div class="card-body">
                        <h6 class="text-primary">üìä Estat√≠sticas de Trades</h6>
                        <ul class="list-unstyled mb-0">
                            <li>Total de trades: <strong>${r.total_trades}</strong></li>
                            <li>‚úÖ Vencedores: <strong class="text-success">${r.winning_trades}</strong></li>
                            <li>‚ùå Perdedores: <strong class="text-danger">${r.losing_trades}</strong></li>
                            <li>üéØ Sinais totais: <strong>${r.total_signals}</strong></li>
                            <li>üìà BUY: <strong class="text-success">${r.buy_signals || 0}</strong></li>
                            <li>üìâ SELL: <strong class="text-danger">${r.sell_signals || 0}</strong></li>
                            <li>üìä Candles analisados: <strong>${r.candles_analyzed}</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-dark text-white border-secondary">
                    <div class="card-body">
                        <h6 class="text-primary">üí∞ Performance Financeira</h6>
                        <ul class="list-unstyled mb-0">
                            <li>Capital inicial: <strong>$${r.initial_capital.toFixed(2)}</strong></li>
                            <li>Capital final: <strong>$${r.final_capital.toFixed(2)}</strong></li>
                            <li>P&L: <strong class="${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</strong></li>
                            <li>Retorno: <strong class="${pnlClass}">${r.roi >= 0 ? '+' : ''}${r.roi.toFixed(2)}%</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        ${result.strategy_details && result.strategy_details.length > 0 ? `
        <div class="card bg-dark text-white border-secondary mt-3">
            <div class="card-body">
                <h6 class="text-primary">üéØ Detalhes por Estrat√©gia</h6>
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Estrat√©gia</th>
                                <th>Sinais</th>
                                <th>Peso</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.strategy_details.map(s => `
                                <tr>
                                    <td>${s.name}</td>
                                    <td>${s.signals}</td>
                                    <td>${s.weight.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        ` : ''}
    `;
    
    // Mostrar recomenda√ß√µes IA se habilitado
    if (document.getElementById('enable-sk').checked && r.win_rate > 0) {
        document.getElementById('recommendations-card').style.display = 'block';
        const performance = r.win_rate >= 70 ? 'Excelente' : r.win_rate >= 60 ? 'Boa' : 'Moderada';
        document.getElementById('ai-recommendations').innerHTML = `
            <div class="alert alert-info bg-dark border-info text-white">
                <h6><i class="bi bi-robot"></i> An√°lise do Semantic Kernel Advisor</h6>
                <p>üéØ <strong>Performance ${performance}!</strong> O backtest demonstrou win rate de ${r.win_rate.toFixed(1)}% com ROI de ${r.roi.toFixed(2)}%.</p>
                <p>üí° <strong>Insights:</strong></p>
                <ul>
                    <li>${r.total_trades} trades executados em ${r.candles_analyzed} candles analisados</li>
                    <li>Taxa de convers√£o sinal‚Üítrade: ${((r.total_trades / r.total_signals) * 100).toFixed(1)}%</li>
                    <li>${result.strategy_details ? result.strategy_details.length : 0} estrat√©gias trabalhando em conflu√™ncia</li>
                </ul>
            </div>
        `;
    }
}

// Cache Management Functions
function manageCacheModal() {
    const modal = new bootstrap.Modal(document.getElementById('cacheModal'));
    modal.show();
    loadCacheList();
}

async function loadCacheList() {
    try {
        const response = await fetch('/api/cache/list');
        const data = await response.json();
        
        const cacheListDiv = document.getElementById('cache-list');
        
        if (data.cache_files && data.cache_files.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>Arquivo</th><th>Tamanho</th><th>A√ß√µes</th></tr></thead><tbody>';
            
            data.cache_files.forEach(file => {
                html += `
                    <tr>
                        <td><small>${file.name}</small></td>
                        <td><small>${file.size}</small></td>
                        <td><button class="btn btn-danger btn-sm" onclick="deleteCache('${file.name}')"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            html += `<p class="text-muted mt-2">Total: ${data.cache_files.length} arquivo(s) | Tamanho total: ${data.total_size}</p>`;
            cacheListDiv.innerHTML = html;
        } else {
            cacheListDiv.innerHTML = '<p class="text-muted">Nenhum arquivo em cache</p>';
        }
    } catch (error) {
        console.error('Erro ao carregar cache:', error);
        document.getElementById('cache-list').innerHTML = '<p class="text-danger">Erro ao carregar cache</p>';
    }
}

async function deleteCache(filename) {
    if (!confirm(`Deletar ${filename}?`)) return;
    
    try {
        const response = await fetch('/api/cache/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename})
        });
        
        const result = await response.json();
        if (result.success) {
            alert('‚úÖ Cache deletado!');
            loadCacheList();
        } else {
            alert('‚ùå Erro ao deletar cache');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao deletar cache');
    }
}

async function clearAllCache() {
    if (!confirm('‚ö†Ô∏è Limpar TODO o cache?\n\nIsto ir√° deletar todos os dados hist√≥ricos salvos.')) return;
    
    try {
        const response = await fetch('/api/cache/clear', {method: 'POST'});
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Todo cache foi limpo!');
            loadCacheList();
        } else {
            alert('‚ùå Erro ao limpar cache');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao limpar cache');
    }
}
</script>
{% endblock %}
