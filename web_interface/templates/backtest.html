{% extends "base.html" %}

{% block title %}Backtest - Market Manus{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4"><i class="bi bi-bar-chart-line"></i> Backtest</h1>
        <p class="lead">Teste suas estrat√©gias com dados hist√≥ricos</p>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Configura√ß√µes</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">üí± Ativo</label>
                    <select class="form-select" id="backtest-asset">
                        <option value="BTCUSDT" selected>BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="ADAUSDT">ADA/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">‚è∞ Timeframe</label>
                    <select class="form-select" id="backtest-timeframe">
                        <option value="1m">1 Minuto</option>
                        <option value="5m">5 Minutos</option>
                        <option value="15m" selected>15 Minutos</option>
                        <option value="1h">1 Hora</option>
                        <option value="4h">4 Horas</option>
                        <option value="1d">1 Dia</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üìÖ Data Inicial</label>
                    <input type="date" class="form-control" id="backtest-start-date">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üìÖ Data Final</label>
                    <input type="date" class="form-control" id="backtest-end-date">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üí∞ Capital Inicial</label>
                    <input type="number" class="form-control" id="backtest-capital" value="10000" step="100">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">üéØ Modo de Conflu√™ncia</label>
                    <select class="form-select" id="backtest-mode">
                        <option value="WEIGHTED" selected>Weighted</option>
                        <option value="MAJORITY">Majority</option>
                        <option value="ALL">All</option>
                        <option value="ANY">Any</option>
                    </select>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enable-manus-ai">
                    <label class="form-check-label" for="enable-manus-ai">
                        ü§ñ Manus AI Premium
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enable-sk">
                    <label class="form-check-label" for="enable-sk">
                        üß† Semantic Kernel Advisor
                    </label>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" onclick="executeBacktest()">
                        <i class="bi bi-play-fill"></i> Executar Backtest
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Resultados</h5>
            </div>
            <div class="card-body">
                <div id="backtest-results" class="text-center text-muted py-5">
                    <i class="bi bi-bar-chart" style="font-size: 4rem;"></i>
                    <p class="mt-3">Configure o backtest e clique em "Executar Backtest"</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3" id="recommendations-card" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Recomenda√ß√µes IA</h5>
            </div>
            <div class="card-body" id="ai-recommendations">
                
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Definir data padr√£o (√∫ltimos 30 dias)
const today = new Date();
const thirtyDaysAgo = new Date(today);
thirtyDaysAgo.setDate(today.getDate() - 30);

document.getElementById('backtest-start-date').valueAsDate = thirtyDaysAgo;
document.getElementById('backtest-end-date').valueAsDate = today;

// Carregar estrat√©gias da URL se houver
const urlParams = new URLSearchParams(window.location.search);
const strategiesParam = urlParams.get('strategies');
const combinationParam = urlParams.get('combination');

if (strategiesParam) {
    console.log('Estrat√©gias selecionadas:', strategiesParam);
}

if (combinationParam) {
    console.log('Combina√ß√£o selecionada:', combinationParam);
}

async function executeBacktest() {
    const resultsDiv = document.getElementById('backtest-results');
    resultsDiv.innerHTML = `
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Executando backtest...</span>
        </div>
        <p class="mt-3">Executando backtest, aguarde...</p>
    `;
    
    const config = {
        asset: document.getElementById('backtest-asset').value,
        timeframe: document.getElementById('backtest-timeframe').value,
        start_date: document.getElementById('backtest-start-date').value,
        end_date: document.getElementById('backtest-end-date').value,
        initial_capital: parseFloat(document.getElementById('backtest-capital').value),
        mode: document.getElementById('backtest-mode').value,
        manus_ai_enabled: document.getElementById('enable-manus-ai').checked,
        semantic_kernel_enabled: document.getElementById('enable-sk').checked,
        strategies: strategiesParam ? strategiesParam.split(',') : [],
        combination: combinationParam
    };
    
    const result = await runBacktest(config);
    
    if (result) {
        displayResults(result);
        showToast('Sucesso', 'Backtest executado com sucesso!', 'success');
    } else {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Erro ao executar backtest
            </div>
        `;
    }
}

function displayResults(result) {
    const resultsDiv = document.getElementById('backtest-results');
    
    // Simular resultados (remover quando integrado com backend)
    const mockResults = {
        initial_capital: parseFloat(document.getElementById('backtest-capital').value),
        final_capital: parseFloat(document.getElementById('backtest-capital').value) * 1.15,
        roi: 15.0,
        total_trades: 45,
        winning_trades: 35,
        losing_trades: 10,
        win_rate: 77.8,
        total_signals: 52
    };
    
    resultsDiv.innerHTML = `
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card text-bg-primary">
                    <div class="card-body text-center">
                        <h6>Capital Final</h6>
                        <h3>$${mockResults.final_capital.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-bg-success">
                    <div class="card-body text-center">
                        <h6>ROI</h6>
                        <h3>${mockResults.roi.toFixed(2)}%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-bg-info">
                    <div class="card-body text-center">
                        <h6>Win Rate</h6>
                        <h3>${mockResults.win_rate.toFixed(1)}%</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-3 mt-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>üìä Estat√≠sticas de Trades</h6>
                        <ul class="list-unstyled mb-0">
                            <li>Total de trades: <strong>${mockResults.total_trades}</strong></li>
                            <li>‚úÖ Vencedores: <strong class="text-success">${mockResults.winning_trades}</strong></li>
                            <li>‚ùå Perdedores: <strong class="text-danger">${mockResults.losing_trades}</strong></li>
                            <li>üéØ Sinais totais: <strong>${mockResults.total_signals}</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>üí∞ Performance Financeira</h6>
                        <ul class="list-unstyled mb-0">
                            <li>Capital inicial: <strong>$${mockResults.initial_capital.toFixed(2)}</strong></li>
                            <li>Capital final: <strong>$${mockResults.final_capital.toFixed(2)}</strong></li>
                            <li>P&L: <strong class="text-success">+$${(mockResults.final_capital - mockResults.initial_capital).toFixed(2)}</strong></li>
                            <li>Retorno: <strong class="text-success">+${mockResults.roi.toFixed(2)}%</strong></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Mostrar recomenda√ß√µes IA se habilitado
    if (document.getElementById('enable-sk').checked) {
        document.getElementById('recommendations-card').style.display = 'block';
        document.getElementById('ai-recommendations').innerHTML = `
            <div class="alert alert-success">
                <h6><i class="bi bi-robot"></i> An√°lise do Semantic Kernel Advisor</h6>
                <p>üéØ <strong>Performance Excelente!</strong> O backtest demonstrou consist√™ncia com win rate de ${mockResults.win_rate.toFixed(1)}%.</p>
                <p>üí° <strong>Recomenda√ß√µes:</strong></p>
                <ul>
                    <li>Mantenha os pesos atuais das estrat√©gias</li>
                    <li>Considere aumentar position size gradualmente</li>
                    <li>Timeframe atual (15m) est√° otimizado para este setup</li>
                </ul>
            </div>
        `;
    }
}
</script>
{% endblock %}
