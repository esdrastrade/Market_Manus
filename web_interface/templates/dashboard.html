{% extends "base.html" %}

{% block title %}Dashboard - Market Manus{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4"><i class="bi bi-speedometer2"></i> Dashboard</h1>
        <p class="lead">Sistema de Trading Automatizado com IA</p>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-bg-primary">
            <div class="card-body">
                <h6 class="card-subtitle mb-2"><i class="bi bi-currency-dollar"></i> Capital Atual</h6>
                <h2 class="card-title mb-0" id="dashboard-capital">$10,000.00</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-success">
            <div class="card-body">
                <h6 class="card-subtitle mb-2"><i class="bi bi-diagram-3"></i> Estratégias</h6>
                <h2 class="card-title mb-0" id="dashboard-strategies">17</h2>
                <small>12 Clássicas + 5 SMC</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-warning">
            <div class="card-body">
                <h6 class="card-subtitle mb-2"><i class="bi bi-layers"></i> Combinações</h6>
                <h2 class="card-title mb-0" id="dashboard-combinations">22</h2>
                <small>Win Rate 70-80%+</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-bg-info">
            <div class="card-body">
                <h6 class="card-subtitle mb-2"><i class="bi bi-robot"></i> IA Premium</h6>
                <h2 class="card-title mb-0">
                    <span id="ai-status">
                        <i class="bi bi-toggle-off"></i> Verificando...
                    </span>
                </h2>
                <small class="text-muted">Manus AI + Semantic Kernel</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-dark">
                <h5 class="mb-0"><i class="bi bi-activity"></i> Market Overview</h5>
            </div>
            <div class="card-body">
                <div id="market-chart" style="height: 400px;">
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="bi bi-graph-up" style="font-size: 4rem; color: #ccc;"></i>
                            <p class="text-muted mt-3">Selecione um par e timeframe para visualizar</p>
                            <div class="row g-2 mt-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="asset-selector">
                                        <option value="BTCUSDT">BTC/USDT</option>
                                        <option value="ETHUSDT">ETH/USDT</option>
                                        <option value="BNBUSDT">BNB/USDT</option>
                                        <option value="ADAUSDT">ADA/USDT</option>
                                        <option value="SOLUSDT">SOL/USDT</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <select class="form-select" id="timeframe-selector">
                                        <option value="1m">1 Minuto</option>
                                        <option value="5m">5 Minutos</option>
                                        <option value="15m" selected>15 Minutos</option>
                                        <option value="1h">1 Hora</option>
                                        <option value="4h">4 Horas</option>
                                        <option value="1d">1 Dia</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-dark">
                <h5 class="mb-0"><i class="bi bi-newspaper"></i> Market Sentiment</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex gap-2 align-items-center">
                        <select class="form-select form-select-sm" id="sentiment-asset-selector" style="max-width: 160px;">
                            <option value="BTCUSDT" selected>BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="BNBUSDT">BNB/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                        </select>
                        <button class="btn btn-primary btn-sm" id="read-market-btn">
                            <i class="bi bi-search"></i> Ler Mercado
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Fear & Greed Index</label>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 55%;" id="fear-greed-bar">
                            <strong>55 - Neutral</strong>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Market Regime</label>
                    <div class="alert alert-info mb-0" id="regime-alert">
                        <i class="bi bi-arrow-up-right"></i> <strong id="regime-title">--</strong>
                        <p class="mb-0 small" id="regime-desc">Selecione um ativo e clique em Ler Mercado</p>
                    </div>
                </div>
                <div>
                    <label class="form-label">Top Signals (24h)</label>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <small><i class="bi bi-arrow-up text-success"></i> RSI Oversold</small>
                            <span class="badge bg-success">12</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <small><i class="bi bi-arrow-down text-danger"></i> MACD Cross</small>
                            <span class="badge bg-danger">8</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <small><i class="bi bi-graph-up text-primary"></i> BOS Detected</small>
                            <span class="badge bg-primary">5</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/strategies" class="btn btn-outline-primary btn-lg w-100">
                            <i class="bi bi-diagram-3 d-block mb-2" style="font-size: 2rem;"></i>
                            Strategy Lab
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/confluence" class="btn btn-outline-success btn-lg w-100">
                            <i class="bi bi-layers d-block mb-2" style="font-size: 2rem;"></i>
                            Confluence Lab
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/backtest" class="btn btn-outline-warning btn-lg w-100">
                            <i class="bi bi-bar-chart-line d-block mb-2" style="font-size: 2rem;"></i>
                            Run Backtest
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/performance" class="btn btn-outline-info btn-lg w-100">
                            <i class="bi bi-trophy d-block mb-2" style="font-size: 2rem;"></i>
                            Performance
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Atualizar status em tempo real
    function updateDashboard() {
        fetch('/api/system/status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('dashboard-capital').textContent = `$${data.capital.toFixed(2)}`;
                document.getElementById('current-capital').textContent = `$${data.capital.toFixed(2)}`;
                document.getElementById('dashboard-strategies').textContent = data.strategies_count;
                document.getElementById('dashboard-combinations').textContent = data.combinations_count;
            })
            .catch(error => console.error('Erro ao atualizar dashboard:', error));
    }
    
    // Atualizar a cada 5 segundos
    setInterval(updateDashboard, 5000);
    
    // Atualizar na carga
    updateDashboard();

    // Atualiza status do IA Premium (Manus AI)
    function updateAIStatus() {
        fetch('/api/connectivity/manus')
            .then(r => r.json())
            .then(data => {
                const el = document.getElementById('ai-status');
                if (!el) return;
                if (data.configured) {
                    el.innerHTML = '<i class="bi bi-toggle-on"></i> Ativo';
                } else {
                    el.innerHTML = '<i class="bi bi-toggle-off"></i> Inativo';
                }
            })
            .catch(() => {
                const el = document.getElementById('ai-status');
                if (el) el.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Indisponível';
            });
    }

    // Ler mercado sob demanda no Dashboard
    async function readMarket() {
        const assetSel = document.getElementById('sentiment-asset-selector');
        const asset = assetSel ? assetSel.value : 'BTCUSDT';
        try {
            const response = await fetch(`/api/sentiment/${asset}`);
            const data = await response.json();

            // Fear & Greed
            if (data.fear_greed) {
                const value = parseInt(data.fear_greed.value, 10) || 0;
                const label = data.fear_greed.label || 'Neutral';
                const bar = document.getElementById('fear-greed-bar');
                if (bar) {
                    bar.style.width = `${value}%`;
                    // Cor por label
                    bar.className = 'progress-bar ' + (
                        label.includes('Extreme Fear') ? 'bg-danger' :
                        label.includes('Fear') ? 'bg-warning' :
                        label.includes('Extreme Greed') ? 'bg-success' :
                        label.includes('Greed') ? 'bg-success' : 'bg-secondary'
                    );
                    bar.innerHTML = `<strong>${value} - ${label}</strong>`;
                }
            }

            // Regime
            if (data.prognosis) {
                const titleEl = document.getElementById('regime-title');
                const descEl = document.getElementById('regime-desc');
                const alertEl = document.getElementById('regime-alert');
                const regime = data.prognosis.regime || 'NEUTRAL';
                if (titleEl) titleEl.textContent = regime;
                if (descEl) descEl.textContent = data.prognosis.description || '';
                if (alertEl) {
                    let alertClass = 'alert-info';
                    if (regime === 'BULLISH') alertClass = 'alert-success';
                    else if (regime === 'BEARISH') alertClass = 'alert-danger';
                    else if (regime === 'CORRECTION') alertClass = 'alert-warning';
                    alertEl.className = `alert ${alertClass} mb-0`;
                }
            }
        } catch (e) {
            console.error('Erro ao ler mercado:', e);
            alert('Erro ao ler mercado');
        }
    }

    // Bind de eventos na carga
    document.addEventListener('DOMContentLoaded', () => {
        updateAIStatus();
        const btn = document.getElementById('read-market-btn');
        if (btn) btn.addEventListener('click', readMarket);
    });
</script>
{% endblock %}
