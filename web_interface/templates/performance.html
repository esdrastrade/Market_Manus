{% extends "base.html" %}

{% block title %}Performance - Market Manus{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4"><i class="bi bi-trophy"></i> Performance History</h1>
        <p class="lead">Histórico e análise de resultados</p>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-dark border-success text-white">
            <div class="card-body text-center">
                <h6 class="text-muted">Win Rate Geral</h6>
                <h3 class="text-success">---%</h3>
                <small class="text-muted">Todos os backtests</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-primary text-white">
            <div class="card-body text-center">
                <h6 class="text-muted">Total de Backtests</h6>
                <h3 class="text-primary">---</h3>
                <small class="text-muted">Registrados</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-warning text-white">
            <div class="card-body text-center">
                <h6 class="text-muted">Melhor Combinação</h6>
                <h3 class="text-warning">---</h3>
                <small class="text-muted">Win rate mais alto</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-info text-white">
            <div class="card-body text-center">
                <h6 class="text-muted">ROI Médio</h6>
                <h3 class="text-info">---</h3>
                <small class="text-muted">Todos os backtests</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-12">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Histórico de Backtests</h5>
                <div class="btn-group">
                    <button class="btn btn-success btn-sm" onclick="exportResults('json')">
                        <i class="bi bi-download"></i> JSON
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportResults('csv')">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Ativo</th>
                                <th>Timeframe</th>
                                <th>Combinação</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>ROI</th>
                                <th>IA</th>
                            </tr>
                        </thead>
                        <tbody id="backtest-history">
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    Nenhum backtest registrado ainda
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Win Rate por Timeframe</h5>
            </div>
            <div class="card-body">
                <canvas id="timeframe-chart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card bg-dark text-white border-secondary">
            <div class="card-header bg-dark text-white border-bottom border-secondary">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuição de Modos</h5>
            </div>
            <div class="card-body">
                <canvas id="mode-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
async function loadPerformanceData() {
    try {
        const response = await fetch('/api/performance/summary');
        const data = await response.json();
        
        if (data.error) {
            console.error('Erro ao carregar performance:', data.error);
            return;
        }
        
        // Atualizar cards de métricas
        document.querySelector('.col-md-3:nth-child(1) h3').textContent = 
            data.avg_win_rate ? `${data.avg_win_rate.toFixed(1)}%` : '0%';
        document.querySelector('.col-md-3:nth-child(2) h3').textContent = data.total_backtests || '0';
        document.querySelector('.col-md-3:nth-child(3) h3').textContent = 
            data.best_combination ? data.best_combination.name : 'N/A';
        document.querySelector('.col-md-3:nth-child(4) h3').textContent = 
            data.avg_roi ? `${data.avg_roi >= 0 ? '+' : ''}${data.avg_roi.toFixed(2)}%` : '0%';
        
        // Atualizar tabela de histórico
        const tbody = document.getElementById('backtest-history');
        if (data.recent_backtests && data.recent_backtests.length > 0) {
            tbody.innerHTML = data.recent_backtests.map(b => `
                <tr>
                    <td>${new Date(b.timestamp).toLocaleString('pt-BR')}</td>
                    <td>${b.asset}</td>
                    <td>${b.timeframe}</td>
                    <td>${b.combination_name}</td>
                    <td>${b.total_trades}</td>
                    <td class="${b.win_rate >= 70 ? 'text-success' : b.win_rate >= 50 ? 'text-warning' : 'text-danger'}">${b.win_rate.toFixed(1)}%</td>
                    <td class="${b.roi >= 0 ? 'text-success' : 'text-danger'}">${b.roi >= 0 ? '+' : ''}${b.roi.toFixed(2)}%</td>
                    <td>
                        ${b.manus_ai_enabled ? '<span class="badge bg-primary">AI</span> ' : ''}
                        ${b.semantic_kernel_enabled ? '<span class="badge bg-info">SK</span>' : ''}
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhum backtest registrado ainda</td></tr>';
        }
        
    } catch (error) {
        console.error('Erro ao carregar dados de performance:', error);
    }
}

// Carregar dados ao iniciar
loadPerformanceData();

// Gráfico de Win Rate por Timeframe
const timeframeCtx = document.getElementById('timeframe-chart');
new Chart(timeframeCtx, {
    type: 'bar',
    data: {
        labels: ['1m', '5m', '15m', '1h', '4h', '1d'],
        datasets: [{
            label: 'Win Rate (%)',
            data: [0, 0, 0, 0, 0, 0],
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});

// Gráfico de Distribuição de Modos
const modeCtx = document.getElementById('mode-chart');
new Chart(modeCtx, {
    type: 'doughnut',
    data: {
        labels: ['Weighted', 'Majority', 'All', 'Any'],
        datasets: [{
            data: [0, 0, 0, 0],
            backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true
    }
});

loadPerformanceData();

// Função de Exportação
async function exportResults(format) {
    try {
        const response = await fetch(`/api/performance/export?format=${format}`);
        
        if (!response.ok) {
            alert('❌ Erro ao exportar resultados');
            return;
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `market_manus_performance_${new Date().toISOString().slice(0,10)}.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        alert(`✅ Relatório exportado em ${format.toUpperCase()}!`);
    } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('❌ Erro ao exportar resultados');
    }
}
</script>
{% endblock %}
