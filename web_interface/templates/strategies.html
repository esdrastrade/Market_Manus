{% extends "base.html" %}

{% block title %}Strategy Lab - Market Manus{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4"><i class="bi bi-diagram-3"></i> Strategy Lab V6</h1>
        <p class="lead">17 Estratégias Profissionais (12 Clássicas + 5 SMC)</p>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Estratégias Clássicas (12)</h5>
            </div>
            <div class="card-body" id="classic-strategies">
                <div class="loading-block">
                    <div class="spinner-border spinner-lg text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <span class="state-label"><i class="bi bi-hourglass-split"></i> Carregando estratégias...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Smart Money Concepts (5)</h5>
            </div>
            <div class="card-body" id="smc-strategies">
                <div class="loading-block">
                    <div class="spinner-border spinner-lg text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <span class="state-label"><i class="bi bi-lightning"></i> Carregando SMC...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-check2-square"></i> Estratégias Selecionadas</h5>
            </div>
            <div class="card-body">
                <div id="selected-strategies" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Selecione estratégias acima para começar
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="runBacktest()">
                        <i class="bi bi-play-fill"></i> Executar Backtest
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        <i class="bi bi-x-circle"></i> Limpar Seleção
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedStrategies = [];

async function loadAllStrategies() {
    const strategies = await loadStrategies();
    
    const classicContainer = document.getElementById('classic-strategies');
    const smcContainer = document.getElementById('smc-strategies');
    
    classicContainer.innerHTML = '';
    smcContainer.innerHTML = '';
    
    strategies.forEach(strategy => {
        const card = `
            <div class="card strategy-card mb-2" onclick="toggleStrategy('${strategy.key}')" id="strategy-${strategy.key}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${strategy.emoji} ${strategy.name}</strong>
                            <br><small class="text-muted">${strategy.description || ''}</small>
                        </div>
                        <i class="bi bi-circle" id="check-${strategy.key}"></i>
                    </div>
                </div>
            </div>
        `;
        
        if (strategy.type === 'smc') {
            smcContainer.innerHTML += card;
        } else {
            classicContainer.innerHTML += card;
        }
    });
}

function toggleStrategy(key) {
    const index = selectedStrategies.indexOf(key);
    const card = document.getElementById(`strategy-${key}`);
    const check = document.getElementById(`check-${key}`);
    
    if (index === -1) {
        selectedStrategies.push(key);
        card.classList.add('selected');
        check.classList.remove('bi-circle');
        check.classList.add('bi-check-circle-fill', 'text-success');
    } else {
        selectedStrategies.splice(index, 1);
        card.classList.remove('selected');
        check.classList.remove('bi-check-circle-fill', 'text-success');
        check.classList.add('bi-circle');
    }
    
    updateSelectedDisplay();
}

function updateSelectedDisplay() {
    const display = document.getElementById('selected-strategies');
    
    if (selectedStrategies.length === 0) {
        display.innerHTML = '<i class="bi bi-info-circle"></i> Selecione estratégias acima para começar';
        display.className = 'alert alert-info';
    } else {
        display.innerHTML = `<i class="bi bi-check-circle"></i> <strong>${selectedStrategies.length}</strong> estratégias selecionadas: ${selectedStrategies.join(', ')}`;
        display.className = 'alert alert-success';
    }
}

function clearSelection() {
    selectedStrategies = [];
    document.querySelectorAll('.strategy-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('[id^="check-"]').forEach(check => {
        check.classList.remove('bi-check-circle-fill', 'text-success');
        check.classList.add('bi-circle');
    });
    updateSelectedDisplay();
}

function runBacktest() {
    if (selectedStrategies.length === 0) {
        showToast('Aviso', 'Selecione pelo menos uma estratégia', 'warning');
        return;
    }
    
    window.location.href = `/backtest?strategies=${selectedStrategies.join(',')}`;
}

loadAllStrategies();
</script>
{% endblock %}
